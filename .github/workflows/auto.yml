name: check for chart updates
on: { workflow_dispatch, schedule: [cron: '0 0 * * *'] }
jobs:
  update:
    name: chart version update [${{ matrix.attrs.attr }}]
    strategy:
      fail-fast: false
      matrix:
        attrs:
          - attr: airflow
            cmd: chart_scan_airflow
            vfile: ./hex/hex/k8s/helm/airflow/airflow.json
          - attr: cert-manager
            cmd: chart_scan_cert-manager
            vfile: ./hex/hex/k8s/helm/cert-manager/cert-manager.json
          - attr: external-secrets
            cmd: chart_scan_external-secrets
            vfile: ./hex/hex/k8s/helm/external-secrets/external-secrets.json
          - attr: gitlab-runner
            cmd: chart_scan_gitlab-runner
            vfile: ./hex/hex/k8s/helm/gitlab-runner/gitlab-runner.json
          - attr: jupyterhub
            cmd: chart_scan_jupyterhub
            vfile: ./hex/hex/k8s/helm/jupyterhub/jupyterhub.json
          - attr: loki
            cmd: chart_scan_loki
            vfile: ./hex/hex/k8s/helm/grafana/loki.json
          - attr: mimir
            cmd: chart_scan_mimir
            vfile: ./hex/hex/k8s/helm/grafana/mimir.json
          - attr: netbox
            cmd: chart_scan_netbox
            vfile: ./hex/hex/k8s/helm/netbox/netbox.json
          - attr: open-webui
            cmd: chart_scan_open-webui
            vfile: ./hex/hex/k8s/helm/open-webui/open-webui.json
          - attr: otf
            cmd: chart_scan_otf
            vfile: ./hex/hex/k8s/helm/otf/otf.json
          - attr: otf
            cmd: chart_scan_otf
            vfile: ./hex/hex/k8s/helm/otf/otf.json
          - attr: prefect-server
            cmd: chart_scan_prefect-server
            vfile: ./hex/hex/k8s/helm/prefect/server.json
          - attr: prefect-worker
            cmd: chart_scan_prefect-worker
            vfile: ./hex/hex/k8s/helm/prefect/worker.json
          - attr: questdb
            cmd: chart_scan_questdb
            vfile: ./hex/hex/k8s/helm/questdb/questdb.json
          - attr: redpanda
            cmd: chart_scan_redpanda
            vfile: ./hex/hex/k8s/helm/redpanda/redpanda.json
          - attr: tempo
            cmd: chart_scan_tempo
            vfile: ./hex/hex/k8s/helm/grafana/tempo.json
          - attr: traefik
            cmd: chart_scan_traefik
            vfile: ./hex/hex/k8s/helm/grafana/traefik.json
    runs-on: ubuntu-24.04
    env:
      GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          persist-credentials: false
      - uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            extra-substituters = https://cache.g7c.us
            extra-trusted-public-keys = cache.g7c.us:dSWpE2B5zK/Fahd7npIQWM4izRnVL+a4LiCAnrjdoFY=
      - run: nix run github:jpetrucciani/nix#${{ matrix.attrs.cmd }} -- -u ${{ matrix.attrs.vfile }}
      - uses: peter-evans/create-pull-request@v8.1.0
        id: pr
        with:
          delete-branch: true
          author: jacobi petrucciani <j@cobi.dev>
          title: '[auto] chart update (${{ matrix.attrs.attr }})'
          commit-message: '[auto] chart update (${{ matrix.attrs.attr }})'
          branch: auto-chart-update-${{ matrix.attrs.attr }}
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      - name: automerge
        if: ${{ steps.pr.outputs.pull-request-number }}
        env:
          PR_URL: ${{ steps.pr.outputs.pull-request-url }}
        run: nix run github:jpetrucciani/nix#github_automerge
