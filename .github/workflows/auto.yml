name: check for chart updates
on: { workflow_dispatch, schedule: [cron: '0 0 * * *'] }
jobs:
  update:
    name: chart version update [${{ matrix.attrs.attr }}]
    strategy:
      fail-fast: false
      matrix:
        attrs:
          - attr: open-webui
            cmd: chart_scan_open-webui
            vfile: ./hex/hex/k8s/helm/open-webui/open-webui.json
          - attr: loki
            cmd: chart_scan_loki
            vfile: ./hex/hex/k8s/helm/grafana/loki.json
          - attr: mimir
            cmd: chart_scan_mimir
            vfile: ./hex/hex/k8s/helm/grafana/mimir.json
          - attr: tempo
            cmd: chart_scan_tempo
            vfile: ./hex/hex/k8s/helm/grafana/tempo.json
          - attr: cert-manager
            cmd: chart_scan_cert-manager
            vfile: ./hex/hex/k8s/helm/cert-manager/cert-manager.json
          - attr: netbox
            cmd: chart_scan_netbox
            vfile: ./hex/hex/k8s/helm/netbox/netbox.json
    runs-on: ubuntu-24.04
    env:
      GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          persist-credentials: false
      - uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            extra-substituters = https://cache.g7c.us
            extra-trusted-public-keys = cache.g7c.us:dSWpE2B5zK/Fahd7npIQWM4izRnVL+a4LiCAnrjdoFY=
      - run: nix run github:jpetrucciani/nix#${{ matrix.attrs.cmd }} -- -u ${{ matrix.attrs.vfile }}
      - uses: peter-evans/create-pull-request@v8.1.0
        id: pr
        with:
          delete-branch: true
          author: jacobi petrucciani <j@cobi.dev>
          title: '[auto] chart update (${{ matrix.attrs.attr }})'
          commit-message: '[auto] chart update (${{ matrix.attrs.attr }})'
          branch: auto-chart-update-${{ matrix.attrs.attr }}
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      - name: automerge
        if: ${{ steps.pr.outputs.pull-request-number }}
        env:
          PR_URL: ${{ steps.pr.outputs.pull-request-url }}
        shell: bash
        run: |
          set -euo pipefail
          max_attempts=3
          attempt=1
          while (( attempt <= max_attempts )); do
            echo "Attempt $attempt/$max_attempts: gh pr merge --auto --squash $PR_URL"
            out="$(mktemp)"
            err="$(mktemp)"
            if gh pr merge --auto --squash "$PR_URL" >"$out" 2>"$err"; then
              echo "merge succeeded"
              cat "$out"
              exit 0
            fi
            echo "merge failed"
            cat "$err" >&2
            if grep -q "Base branch was modified" "$err"; then
              echo "detected base-branch race. rebase-updating PR branch then retrying"
              gh pr update-branch --rebase "$PR_URL" || true
            elif grep -q "Protected branch rules not configured for this branch" "$err"; then
              echo "detected transient branch-rules evaluation error. waiting and retrying"
              gh pr view "$PR_URL" --json mergeable,mergeStateStatus >/dev/null || true
            elif grep -q "Pull request is in unstable status" "$err"; then
              echo "detected transient unstable status. waiting and retrying"
              gh pr view "$PR_URL" --json mergeable,mergeStateStatus >/dev/null || true
            else
              echo "Non-retryable failure."
              exit 1
            fi
            sleep_time=$(( 3 + RANDOM % 6 ))  # 3-8s
            echo "Sleeping ${sleep_time}s before retry..."
            sleep "$sleep_time"
            attempt=$(( attempt + 1 ))
          done
          echo "exceeded retries ($max_attempts)"
          exit 1
